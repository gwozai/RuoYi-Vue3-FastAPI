# é€šçŸ¥æœåŠ¡ä½¿ç”¨æ•™ç¨‹

é€šçŸ¥æœåŠ¡æ˜¯ä¸€ä¸ªç»Ÿä¸€çš„æ¶ˆæ¯æ¨é€å¹³å°ï¼Œæ”¯æŒå¤šç§é€šçŸ¥æ¸ é“ï¼ˆé£ä¹¦ã€ä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ç­‰ï¼‰ï¼Œæä¾›ç®€å•çš„ API æ¥å£ä¾›å¤–éƒ¨ç³»ç»Ÿè°ƒç”¨ã€‚

---

## åŠŸèƒ½ç‰¹æ€§

- **å¤šå¹³å°æ”¯æŒ**ï¼šé£ä¹¦ã€ä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ç­‰ä¸»æµ IM å¹³å°
- **ç»Ÿä¸€ API**ï¼šä¸€ä¸ªæ¥å£åŒæ—¶å‘é€åˆ°å¤šä¸ªæ¸ é“
- **API å¯†é’¥ç®¡ç†**ï¼šå®‰å…¨çš„å¯†é’¥è®¤è¯æœºåˆ¶
- **å‘é€è®°å½•**ï¼šå®Œæ•´çš„å‘é€æ—¥å¿—å’Œç»Ÿè®¡
- **æ¯æ—¥é™é¢**ï¼šå¯é…ç½®çš„è°ƒç”¨é¢‘ç‡é™åˆ¶

---

## å¿«é€Ÿå¼€å§‹

### 1. é…ç½®é€šçŸ¥å¹³å°

ç³»ç»Ÿå·²é¢„ç½®ä¸‰ä¸ªå¹³å°ï¼š

| å¹³å° | ç¼–ç  | Webhook æ¨¡æ¿ |
|------|------|-------------|
| é£ä¹¦ | feishu | `https://open.feishu.cn/open-apis/bot/v2/hook/{key}` |
| ä¼ä¸šå¾®ä¿¡ | wecom | `https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key={key}` |
| é’‰é’‰ | dingtalk | `https://oapi.dingtalk.com/robot/send?access_token={key}` |

### 2. åˆ›å»ºé€šçŸ¥æ¸ é“

1. è¿›å…¥ **é€šçŸ¥æœåŠ¡ â†’ æˆ‘çš„æ¸ é“**
2. ç‚¹å‡» **æ–°å¢** æŒ‰é’®
3. å¡«å†™æ¸ é“ä¿¡æ¯ï¼š
   - **æ¸ é“åç§°**ï¼šè‡ªå®šä¹‰åç§°
   - **å¹³å°**ï¼šé€‰æ‹©é€šçŸ¥å¹³å°
   - **Webhookå¯†é’¥**ï¼šä»å¯¹åº”å¹³å°è·å–çš„æœºå™¨äººå¯†é’¥
   - **æ˜¯å¦é»˜è®¤**ï¼šè®¾ä¸ºé»˜è®¤æ¸ é“

### 3. ç”Ÿæˆ API å¯†é’¥

1. è¿›å…¥ **é€šçŸ¥æœåŠ¡ â†’ APIå¯†é’¥**
2. ç‚¹å‡» **ç”Ÿæˆå¯†é’¥** æŒ‰é’®
3. å¡«å†™å¯†é’¥ä¿¡æ¯ï¼š
   - **å¯†é’¥åç§°**ï¼šè‡ªå®šä¹‰åç§°
   - **ç»‘å®šæ¸ é“**ï¼šé€‰æ‹©è¦å‘é€çš„æ¸ é“ï¼ˆå¯å¤šé€‰ï¼‰
   - **æ¯æ—¥é™é¢**ï¼šæ¯æ—¥æœ€å¤§è°ƒç”¨æ¬¡æ•°
4. ä¿å­˜åå¤åˆ¶ç”Ÿæˆçš„ API å¯†é’¥

> âš ï¸ **é‡è¦**ï¼šAPI å¯†é’¥åªåœ¨ç”Ÿæˆæ—¶æ˜¾ç¤ºä¸€æ¬¡ï¼Œè¯·å¦¥å–„ä¿å­˜ï¼

### 4. å‘é€é€šçŸ¥

ä½¿ç”¨ç”Ÿæˆçš„ API å¯†é’¥è°ƒç”¨å‘é€æ¥å£ï¼š

```bash
# GET è¯·æ±‚
curl "http://localhost:9099/notify/send/{api_key}?title=æ ‡é¢˜&content=å†…å®¹"

# POST è¯·æ±‚
curl -X POST "http://localhost:9099/notify/send/{api_key}" \
  -H "Content-Type: application/json" \
  -d '{"title":"æ ‡é¢˜","content":"å†…å®¹"}'
```

---

## API æ¥å£

### å‘é€é€šçŸ¥

**æ¥å£åœ°å€**ï¼š`/notify/send/{api_key}`

**è¯·æ±‚æ–¹å¼**ï¼š`GET` æˆ– `POST`

**è¯·æ±‚å‚æ•°**ï¼š

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| api_key | string | æ˜¯ | API å¯†é’¥ï¼ˆè·¯å¾„å‚æ•°ï¼‰ |
| title | string | å¦ | æ¶ˆæ¯æ ‡é¢˜ |
| content | string | æ˜¯ | æ¶ˆæ¯å†…å®¹ |
| msg_type | string | å¦ | æ¶ˆæ¯ç±»å‹ï¼Œé»˜è®¤ `text` |
| channel_ids | string | å¦ | æŒ‡å®šæ¸ é“IDï¼Œé€—å·åˆ†éš” |

**GET è¯·æ±‚ç¤ºä¾‹**ï¼š

```bash
curl "http://localhost:9099/notify/send/your_api_key?title=ç³»ç»Ÿé€šçŸ¥&content=æœåŠ¡å™¨CPUä½¿ç”¨ç‡è¶…è¿‡90%"
```

**POST è¯·æ±‚ç¤ºä¾‹**ï¼š

```bash
curl -X POST "http://localhost:9099/notify/send/your_api_key" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "ç³»ç»Ÿé€šçŸ¥",
    "content": "æœåŠ¡å™¨CPUä½¿ç”¨ç‡è¶…è¿‡90%"
  }'
```

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 200,
  "msg": "å‘é€æˆåŠŸ (2/2)",
  "data": {
    "success": true,
    "total": 2,
    "success_count": 2,
    "fail_count": 0,
    "results": [
      {
        "success": true,
        "channel_id": 1,
        "channel_name": "é£ä¹¦é€šçŸ¥",
        "platform": "é£ä¹¦",
        "error": null,
        "cost_time": 450
      },
      {
        "success": true,
        "channel_id": 2,
        "channel_name": "ä¼å¾®é€šçŸ¥",
        "platform": "ä¼ä¸šå¾®ä¿¡",
        "error": null,
        "cost_time": 890
      }
    ]
  }
}
```

---

## åå°ç®¡ç†æ¥å£

### é€šçŸ¥å¹³å°ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/notify/platform/list` | è·å–å¹³å°åˆ—è¡¨ |
| POST | `/notify/platform` | æ·»åŠ å¹³å° |
| PUT | `/notify/platform` | ä¿®æ”¹å¹³å° |
| DELETE | `/notify/platform/{ids}` | åˆ é™¤å¹³å° |

### é€šçŸ¥æ¸ é“ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/notify/channel/list` | è·å–æ¸ é“åˆ—è¡¨ |
| POST | `/notify/channel` | æ·»åŠ æ¸ é“ |
| PUT | `/notify/channel` | ä¿®æ”¹æ¸ é“ |
| DELETE | `/notify/channel/{ids}` | åˆ é™¤æ¸ é“ |
| POST | `/notify/channel/test/{id}` | æµ‹è¯•æ¸ é“ |

### API å¯†é’¥ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/notify/key/list` | è·å–å¯†é’¥åˆ—è¡¨ |
| POST | `/notify/key/generate` | ç”Ÿæˆå¯†é’¥ |
| PUT | `/notify/key` | ä¿®æ”¹å¯†é’¥ |
| DELETE | `/notify/key/{ids}` | åˆ é™¤å¯†é’¥ |
| POST | `/notify/key/reset/{id}` | é‡ç½®å¯†é’¥ |

### å‘é€è®°å½•

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/notify/log/list` | è·å–å‘é€è®°å½•åˆ—è¡¨ |
| DELETE | `/notify/log/{ids}` | åˆ é™¤å‘é€è®°å½• |

---

## ä½¿ç”¨åœºæ™¯

### 1. ç›‘æ§å‘Šè­¦

```python
import requests

def send_alert(title, content):
    api_key = "your_api_key"
    url = f"http://localhost:9099/notify/send/{api_key}"
    response = requests.post(url, json={
        "title": title,
        "content": content
    })
    return response.json()

# ä½¿ç”¨ç¤ºä¾‹
send_alert("âš ï¸ æœåŠ¡å™¨å‘Šè­¦", "CPUä½¿ç”¨ç‡è¶…è¿‡90%ï¼Œè¯·åŠæ—¶å¤„ç†ï¼")
```

### 2. å®šæ—¶ä»»åŠ¡é€šçŸ¥

```python
# åœ¨å®šæ—¶ä»»åŠ¡å®Œæˆåå‘é€é€šçŸ¥
def daily_report():
    # ... æ‰§è¡ŒæŠ¥è¡¨ç”Ÿæˆé€»è¾‘ ...
    
    send_alert("ğŸ“Š æ—¥æŠ¥ç”Ÿæˆå®Œæˆ", f"ä»Šæ—¥é”€å”®é¢: Â¥{total_sales}")
```

### 3. ç³»ç»Ÿäº‹ä»¶é€šçŸ¥

```python
# ç”¨æˆ·æ³¨å†ŒæˆåŠŸé€šçŸ¥
def on_user_register(user):
    send_alert("ğŸ‘¤ æ–°ç”¨æˆ·æ³¨å†Œ", f"ç”¨æˆ· {user.username} æ³¨å†ŒæˆåŠŸ")

# è®¢å•æ”¯ä»˜æˆåŠŸé€šçŸ¥
def on_order_paid(order):
    send_alert("ğŸ’° è®¢å•æ”¯ä»˜æˆåŠŸ", f"è®¢å•å·: {order.order_no}\né‡‘é¢: Â¥{order.amount}")
```

---

## è·å– Webhook å¯†é’¥

### é£ä¹¦

1. æ‰“å¼€é£ä¹¦ï¼Œè¿›å…¥ç›®æ ‡ç¾¤èŠ
2. ç‚¹å‡»ç¾¤è®¾ç½® â†’ ç¾¤æœºå™¨äºº â†’ æ·»åŠ æœºå™¨äºº
3. é€‰æ‹© **è‡ªå®šä¹‰æœºå™¨äºº**
4. å¤åˆ¶ Webhook åœ°å€ä¸­çš„å¯†é’¥éƒ¨åˆ†

Webhook æ ¼å¼ï¼š`https://open.feishu.cn/open-apis/bot/v2/hook/{key}`

### ä¼ä¸šå¾®ä¿¡

1. æ‰“å¼€ä¼ä¸šå¾®ä¿¡ï¼Œè¿›å…¥ç›®æ ‡ç¾¤èŠ
2. ç‚¹å‡»ç¾¤è®¾ç½® â†’ ç¾¤æœºå™¨äºº â†’ æ·»åŠ æœºå™¨äºº
3. å¤åˆ¶ Webhook åœ°å€ä¸­çš„ key å‚æ•°

Webhook æ ¼å¼ï¼š`https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key={key}`

### é’‰é’‰

1. æ‰“å¼€é’‰é’‰ï¼Œè¿›å…¥ç›®æ ‡ç¾¤èŠ
2. ç‚¹å‡»ç¾¤è®¾ç½® â†’ æ™ºèƒ½ç¾¤åŠ©æ‰‹ â†’ æ·»åŠ æœºå™¨äºº
3. é€‰æ‹© **è‡ªå®šä¹‰æœºå™¨äºº**
4. å¤åˆ¶ Webhook åœ°å€ä¸­çš„ access_token å‚æ•°

Webhook æ ¼å¼ï¼š`https://oapi.dingtalk.com/robot/send?access_token={key}`

---

## å¸¸è§é—®é¢˜

### Q: å‘é€å¤±è´¥ï¼Œæç¤º HTTP 400

**A**: é€šå¸¸æ˜¯æ¶ˆæ¯å†…å®¹æ ¼å¼é—®é¢˜ï¼Œæ£€æŸ¥å†…å®¹æ˜¯å¦åŒ…å«ç‰¹æ®Šå­—ç¬¦ã€‚

### Q: æ¯æ—¥é™é¢ç”¨å®Œäº†æ€ä¹ˆåŠï¼Ÿ

**A**: å¯ä»¥åœ¨ API å¯†é’¥ç®¡ç†ä¸­ä¿®æ”¹æ¯æ—¥é™é¢ï¼Œæˆ–ç­‰å¾…æ¬¡æ—¥è‡ªåŠ¨é‡ç½®ã€‚

### Q: å¦‚ä½•åªå‘é€åˆ°æŒ‡å®šæ¸ é“ï¼Ÿ

**A**: åœ¨è¯·æ±‚ä¸­æ·»åŠ  `channel_ids` å‚æ•°ï¼ŒæŒ‡å®šæ¸ é“ IDï¼ˆé€—å·åˆ†éš”ï¼‰ã€‚

```bash
curl "http://localhost:9099/notify/send/{api_key}?title=æ ‡é¢˜&content=å†…å®¹&channel_ids=1,2"
```

### Q: å¯†é’¥ä¸¢å¤±äº†æ€ä¹ˆåŠï¼Ÿ

**A**: åœ¨ API å¯†é’¥ç®¡ç†ä¸­ç‚¹å‡» **é‡ç½®** æŒ‰é’®ç”Ÿæˆæ–°å¯†é’¥ï¼ŒåŸå¯†é’¥å°†å¤±æ•ˆã€‚

---

## æ•°æ®åº“è¡¨ç»“æ„

### notify_platformï¼ˆé€šçŸ¥å¹³å°ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| platform_id | int | å¹³å°ID |
| platform_name | varchar(50) | å¹³å°åç§° |
| platform_code | varchar(50) | å¹³å°ç¼–ç  |
| webhook_template | varchar(500) | Webhookæ¨¡æ¿ |
| body_template | text | è¯·æ±‚ä½“æ¨¡æ¿ |
| request_method | varchar(10) | è¯·æ±‚æ–¹å¼ |
| content_type | varchar(100) | Content-Type |
| status | char(1) | çŠ¶æ€ |

### notify_channelï¼ˆé€šçŸ¥æ¸ é“ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| channel_id | int | æ¸ é“ID |
| user_id | int | ç”¨æˆ·ID |
| platform_id | int | å¹³å°ID |
| channel_name | varchar(100) | æ¸ é“åç§° |
| webhook_key | varchar(500) | Webhookå¯†é’¥ |
| is_default | char(1) | æ˜¯å¦é»˜è®¤ |
| use_count | int | ä½¿ç”¨æ¬¡æ•° |
| status | char(1) | çŠ¶æ€ |

### notify_keyï¼ˆAPIå¯†é’¥ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| key_id | int | å¯†é’¥ID |
| user_id | int | ç”¨æˆ·ID |
| key_name | varchar(100) | å¯†é’¥åç§° |
| api_key | varchar(64) | APIå¯†é’¥ |
| channel_ids | varchar(500) | ç»‘å®šæ¸ é“ID |
| daily_limit | int | æ¯æ—¥é™é¢ |
| daily_used | int | ä»Šæ—¥å·²ç”¨ |
| total_count | int | æ€»è°ƒç”¨æ¬¡æ•° |
| status | char(1) | çŠ¶æ€ |

### notify_logï¼ˆå‘é€è®°å½•ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| log_id | int | æ—¥å¿—ID |
| user_id | int | ç”¨æˆ·ID |
| key_id | int | å¯†é’¥ID |
| channel_id | int | æ¸ é“ID |
| platform_id | int | å¹³å°ID |
| title | varchar(200) | æ¶ˆæ¯æ ‡é¢˜ |
| content | text | æ¶ˆæ¯å†…å®¹ |
| status | char(1) | çŠ¶æ€(0æˆåŠŸ 1å¤±è´¥) |
| error_msg | varchar(500) | é”™è¯¯ä¿¡æ¯ |
| cost_time | int | è€—æ—¶(ms) |
| send_time | datetime | å‘é€æ—¶é—´ |
