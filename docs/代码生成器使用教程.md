# 代码生成器使用教程

本教程介绍如何使用 RuoYi-Vue3-FastAPI 系统中的代码生成器，快速创建完整的 CRUD 模块。

---

## 目录

- [功能概述](#功能概述)
- [使用方式](#使用方式)
  - [方式一：Web 界面操作](#方式一web-界面操作)
  - [方式二：命令行脚本](#方式二命令行脚本)
  - [方式三：Python API 调用](#方式三python-api-调用)
- [生成文件说明](#生成文件说明)
- [集成步骤](#集成步骤)
- [配置选项详解](#配置选项详解)
- [常见问题](#常见问题)

---

## 功能概述

代码生成器根据数据库表结构，自动生成完整的前后端 CRUD 代码，大幅减少重复开发工作。

### 生成内容

| 类型 | 文件 | 说明 |
|------|------|------|
| **后端** | `*_do.py` | SQLAlchemy ORM 数据库模型 |
| **后端** | `*_vo.py` | Pydantic 请求/响应模型 |
| **后端** | `*_dao.py` | 数据访问层（CRUD 操作） |
| **后端** | `*_service.py` | 业务逻辑层 |
| **后端** | `*_controller.py` | FastAPI 路由控制器 |
| **前端** | `*.js` | API 接口封装 |
| **前端** | `index.vue` | Vue3 页面组件（列表、表单、搜索） |
| **SQL** | `*_menu.sql` | 菜单和权限 SQL 脚本 |

### 支持的模板类型

- **单表（CRUD）**：标准增删改查
- **树表**：树形结构数据管理

---

## 使用方式

### 方式一：Web 界面操作

适合日常开发，可视化配置字段属性。

#### 1. 创建数据库表

```sql
CREATE TABLE IF NOT EXISTS sys_book (
  book_id         BIGINT          NOT NULL AUTO_INCREMENT    COMMENT '图书ID',
  book_name       VARCHAR(100)    NOT NULL                   COMMENT '图书名称',
  author          VARCHAR(50)     DEFAULT ''                 COMMENT '作者',
  price           DECIMAL(10,2)   DEFAULT 0                  COMMENT '价格',
  status          CHAR(1)         DEFAULT '0'                COMMENT '状态（0正常 1停用）',
  create_by       VARCHAR(64)     DEFAULT ''                 COMMENT '创建者',
  create_time     DATETIME                                   COMMENT '创建时间',
  update_by       VARCHAR(64)     DEFAULT ''                 COMMENT '更新者',
  update_time     DATETIME                                   COMMENT '更新时间',
  remark          VARCHAR(500)    DEFAULT NULL               COMMENT '备注',
  PRIMARY KEY (book_id)
) ENGINE=InnoDB COMMENT = '图书信息表';
```

**表设计规范：**
- 主键使用 `BIGINT` 类型，自增
- 必须包含 `create_by`, `create_time`, `update_by`, `update_time` 字段
- 状态字段使用 `CHAR(1)`，0 表示正常，1 表示停用
- 字段注释会自动生成为表单标签

#### 2. 导入表

1. 登录系统，进入 **系统工具 > 代码生成**
2. 点击 **导入** 按钮
3. 勾选要导入的表，点击 **确定**

#### 3. 配置生成选项

点击表对应的 **编辑** 按钮：

**基本信息**
- 表名称、表描述（自动填充）

**字段信息**

| 配置项 | 说明 |
|--------|------|
| 插入 | 新增时是否包含该字段 |
| 编辑 | 修改时是否包含该字段 |
| 列表 | 列表页是否显示 |
| 查询 | 是否作为查询条件 |
| 查询方式 | `=`（精确）或 `LIKE`（模糊） |
| 必填 | 表单验证是否必填 |
| 显示类型 | 文本框、下拉框、日期控件等 |

**生成信息**

| 配置项 | 示例值 | 说明 |
|--------|--------|------|
| 生成模板 | 单表（增删改查） | 单表或树表 |
| 前端类型 | Vue3 Element Plus | 前端框架 |
| 生成模块名 | system | 模块名称 |
| 生成业务名 | book | 业务名称（小写） |
| 生成功能名 | 图书信息 | 功能描述（中文） |
| 上级菜单 | 系统管理 | 菜单归属 |

#### 4. 生成代码

1. 返回代码生成列表
2. 勾选要生成的表
3. 点击 **生成** 按钮，下载 `vfadmin.zip`

---

### 方式二：命令行脚本

适合批量生成或自动化场景。

```bash
cd ruoyi-fastapi-backend

# 从数据库已有表生成
python scripts/code_generator.py \
    --table sys_book \
    --module system \
    --business book

# 从 SQL 建表语句生成
python scripts/code_generator.py \
    --sql "CREATE TABLE sys_demo (id INT PRIMARY KEY, name VARCHAR(100))" \
    --module system \
    --business demo

# 生成并自动复制到项目目录
python scripts/code_generator.py \
    --table sys_book \
    --module system \
    --business book \
    --auto-install
```

**参数说明：**

| 参数 | 必填 | 说明 |
|------|------|------|
| `--table` | 二选一 | 数据库表名 |
| `--sql` | 二选一 | 建表 SQL 语句 |
| `--module` | 是 | 模块名称（如 system, admin） |
| `--business` | 是 | 业务名称（如 book, user） |
| `--output` | 否 | 输出目录（默认 /tmp/ruoyi-gen） |
| `--auto-install` | 否 | 自动复制到项目目录 |
| `--menu-parent` | 否 | 父菜单 ID |

---

### 方式三：Python API 调用

适合 AI 辅助开发或脚本集成。

```python
import sys
sys.path.insert(0, 'ruoyi-fastapi-backend')
from scripts.gen_api import generate_crud, quick_generate

# 方式 A: 从 SQL 生成
generate_crud(
    sql='''
    CREATE TABLE sys_product (
        product_id INT PRIMARY KEY AUTO_INCREMENT COMMENT '产品ID',
        product_name VARCHAR(100) NOT NULL COMMENT '产品名称',
        price DECIMAL(10,2) COMMENT '价格',
        status CHAR(1) DEFAULT '0' COMMENT '状态',
        create_by VARCHAR(64) COMMENT '创建者',
        create_time DATETIME COMMENT '创建时间',
        update_by VARCHAR(64) COMMENT '更新者',
        update_time DATETIME COMMENT '更新时间',
        remark VARCHAR(500) COMMENT '备注'
    ) COMMENT='产品信息表';
    ''',
    module='system',
    business='product'
)

# 方式 B: 从已有表生成
generate_crud(
    table='sys_user',
    module='system',
    business='user'
)

# 方式 C: 快速生成（简化接口）
quick_generate('order', {
    'order_no': 'varchar(50) 订单号',
    'amount': 'decimal(10,2) 金额',
    'status': 'char(1) 状态',
}, module='system')
```

**`generate_crud` 参数：**

| 参数 | 类型 | 说明 |
|------|------|------|
| `table` | str | 表名（与 sql 二选一） |
| `sql` | str | 建表 SQL（与 table 二选一） |
| `module` | str | 模块名称，默认 'admin' |
| `business` | str | 业务名称，默认从表名推断 |
| `output_dir` | str | 输出目录，默认 '/tmp/ruoyi-gen' |
| `auto_install` | bool | 是否自动复制到项目，默认 False |

---

## 生成文件说明

### 目录结构

```
/tmp/ruoyi-gen/
├── backend/
│   ├── module_{module}/
│   │   ├── controller/{business}_controller.py   # API 路由
│   │   ├── dao/{business}_dao.py                 # 数据访问
│   │   ├── entity/
│   │   │   ├── do/{business}_do.py               # ORM 模型
│   │   │   └── vo/{business}_vo.py               # Pydantic 模型
│   │   └── service/{business}_service.py         # 业务逻辑
│   └── sql/{business}_menu.sql                   # 菜单 SQL
└── frontend/
    └── src/
        ├── api/{module}/{business}.js            # API 接口
        └── views/{module}/{business}/index.vue   # Vue 页面
```

### 文件功能

| 文件 | 说明 |
|------|------|
| `*_do.py` | SQLAlchemy ORM 模型，映射数据库表结构 |
| `*_vo.py` | Pydantic 模型，用于请求参数验证和响应序列化 |
| `*_dao.py` | 数据访问对象，封装增删改查 SQL 操作 |
| `*_service.py` | 业务服务层，处理业务逻辑和事务 |
| `*_controller.py` | FastAPI 路由控制器，定义 RESTful API |
| `*.js` | 前端 API 封装，调用后端接口 |
| `index.vue` | Vue 页面组件，包含表格、搜索、表单弹窗 |
| `*_menu.sql` | 菜单和按钮权限 SQL 脚本 |

---

## 集成步骤

### 1. 复制后端文件

由于项目结构是扁平的 `module_admin`，需要调整 import 路径：

```bash
# 复制实体文件
cp backend/module_system/entity/do/book_do.py \
   ruoyi-fastapi-backend/module_admin/entity/do/

cp backend/module_system/entity/vo/book_vo.py \
   ruoyi-fastapi-backend/module_admin/entity/vo/

# 复制并修改 DAO（调整 import 路径）
sed 's/module_system/module_admin/g' \
    backend/module_system/dao/book_dao.py > \
    ruoyi-fastapi-backend/module_admin/dao/book_dao.py

# 复制并修改 Service
sed 's/module_system/module_admin/g' \
    backend/module_system/service/book_service.py > \
    ruoyi-fastapi-backend/module_admin/service/book_service.py

# 复制并修改 Controller
sed 's/module_system/module_admin/g' \
    backend/module_system/controller/book_controller.py > \
    ruoyi-fastapi-backend/module_admin/controller/book_controller.py
```

### 2. 注册路由

编辑 `ruoyi-fastapi-backend/server.py`：

```python
# 添加 import
from module_admin.controller.book_controller import bookController

# 在 controller_list 中添加
controller_list = [
    # ... 其他控制器
    {'router': bookController, 'tags': ['系统管理-图书管理']},
]
```

### 3. 复制前端文件

```bash
# 复制 API 文件
cp frontend/src/api/system/book.js \
   ruoyi-fastapi-frontend/src/api/system/

# 创建目录并复制页面组件
mkdir -p ruoyi-fastapi-frontend/src/views/system/book
cp frontend/src/views/system/book/index.vue \
   ruoyi-fastapi-frontend/src/views/system/book/
```

### 4. 添加菜单权限

执行生成的菜单 SQL：

```bash
mysql -uroot -p ruoyi-fastapi < backend/sql/book_menu.sql
```

或在 **系统管理 > 菜单管理** 中手动添加：

| 菜单名称 | 类型 | 路由地址 | 组件路径 | 权限标识 |
|----------|------|----------|----------|----------|
| 图书信息 | 菜单 | book | system/book/index | system:book:list |
| 图书信息查询 | 按钮 | - | - | system:book:query |
| 图书信息新增 | 按钮 | - | - | system:book:add |
| 图书信息修改 | 按钮 | - | - | system:book:edit |
| 图书信息删除 | 按钮 | - | - | system:book:remove |
| 图书信息导出 | 按钮 | - | - | system:book:export |

### 5. 重启服务

```bash
# 重启后端
pkill -f "uvicorn"
cd ruoyi-fastapi-backend
python -m uvicorn app:app --host 0.0.0.0 --port 9099 --reload

# 前端热更新自动生效
```

---

## 配置选项详解

### 字段显示类型

| 类型 | 说明 | 适用场景 |
|------|------|----------|
| 文本框 | 单行文本输入 | 名称、编号等短文本 |
| 文本域 | 多行文本输入 | 描述、备注等长文本 |
| 下拉框 | 单选下拉 | 状态、类型等枚举值 |
| 单选框 | 单选按钮组 | 是/否、性别等少量选项 |
| 复选框 | 多选框 | 多选标签 |
| 日期控件 | 日期选择器 | 日期字段 |
| 日期时间 | 日期时间选择器 | 时间戳字段 |
| 图片上传 | 图片上传组件 | 头像、封面等 |
| 文件上传 | 文件上传组件 | 附件 |
| 富文本 | 富文本编辑器 | 文章内容 |

### 查询方式

| 方式 | SQL | 适用场景 |
|------|-----|----------|
| `=` | `WHERE field = value` | 精确匹配（状态、ID） |
| `!=` | `WHERE field != value` | 不等于 |
| `>` | `WHERE field > value` | 大于 |
| `>=` | `WHERE field >= value` | 大于等于 |
| `<` | `WHERE field < value` | 小于 |
| `<=` | `WHERE field <= value` | 小于等于 |
| `LIKE` | `WHERE field LIKE '%value%'` | 模糊匹配（名称） |
| `BETWEEN` | `WHERE field BETWEEN a AND b` | 范围查询（日期） |

---

## 常见问题

### Q1: 生成的代码 import 路径不对？

生成器默认使用 `module_{module}` 路径，但项目实际结构是扁平的 `module_admin`。需要手动替换：

```bash
sed -i 's/module_system/module_admin/g' your_file.py
```

### Q2: 菜单不显示？

1. 确认菜单 SQL 已执行
2. 刷新字典缓存：**系统管理 > 字典管理 > 刷新缓存**
3. 重新登录以刷新权限

### Q3: 接口 404？

1. 确认 Controller 已在 `server.py` 中注册
2. 确认后端服务已重启
3. 检查路由前缀是否正确（如 `/system/book`）

### Q4: 前端页面空白？

1. 检查浏览器控制台是否有错误
2. 确认 Vue 组件文件路径正确
3. 确认 API 文件已正确放置

### Q5: 如何自定义模板？

模板文件位于 `ruoyi-fastapi-backend/module_generator/templates/`：

```
templates/
├── js/api.js.jinja2           # 前端 API
├── python/
│   ├── controller.py.jinja2   # 控制器
│   ├── dao.py.jinja2          # DAO
│   ├── do.py.jinja2           # DO
│   ├── service.py.jinja2      # Service
│   └── vo.py.jinja2           # VO
├── sql/sql.jinja2             # 菜单 SQL
└── vue/
    ├── index.vue.jinja2       # 单表页面
    ├── index-tree.vue.jinja2  # 树表页面
    └── v3/                    # Vue3 模板
```

修改 Jinja2 模板即可自定义生成的代码风格。

---

## 附录：API 接口

代码生成器本身也提供 RESTful API：

| 接口 | 方法 | 说明 |
|------|------|------|
| `/tool/gen/list` | GET | 获取已导入的表列表 |
| `/tool/gen/db/list` | GET | 获取数据库表列表 |
| `/tool/gen/importTable` | POST | 导入表结构 |
| `/tool/gen/{tableId}` | GET | 获取表详情 |
| `/tool/gen` | PUT | 更新表配置 |
| `/tool/gen/{tableIds}` | DELETE | 删除表 |
| `/tool/gen/preview/{tableId}` | GET | 预览生成代码 |
| `/tool/gen/batchGenCode` | GET | 批量生成代码（下载 zip） |
| `/tool/gen/genCode/{tableName}` | GET | 生成代码到本地 |
| `/tool/gen/synchDb/{tableName}` | GET | 同步数据库结构 |
| `/tool/gen/createTable` | POST | 执行建表 SQL |
